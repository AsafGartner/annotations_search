<html>
<head>
<meta charset="UTF-8">
<title>Handmade Hero Search</title>
<style>
    body {
        background-color: #222;
        font-family: sans-serif;
        color: #ddd;
        overflow-y: scroll;
    }

    h2 {
        text-align: center;
    }

    #loadingContainer {
        position: fixed;
        top: 0;
        left: 0;
    }

    .queryContainer {
        width: 1000px;
        margin: 15px auto;
        display: flex;
        flex-direction: horizontal;
    }

    .queryContainer label {
        flex-grow: 0;
        flex-shrink: 0;
    }

    #query {
        flex-grow: 1;
    }

    #results {
        width: 800px;
        margin: 0 auto;
    }

    .dayContainer {
        background-color: #161616;
    }

    .dayContainer:nth-child(2n) {
        background-color: #303030;
    }

    .dayName {
        width: 200px;
        display: inline-block;
        vertical-align: top;
        color: #8A877D;
        font-size: 12px;
        line-height: 16px;
        box-sizing: border-box;
        padding: 5px;
    }

    .markerList {
        display: inline-block;
        width: 600px;
        box-sizing: border-box;
        vertical-align: top;
    }

    .marker {
        padding: 10px 5px;
        cursor: pointer;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        display: block;
        text-decoration: none;
        color: #ddd;
    }

    .marker:first-child {
        border: none;
    }

    .marker b {
        color: black;
        background-color: rgb(255, 155, 0);
    }

    .marker:hover {
        background-color: #444;
    }

    #resultsSummary {
        text-align: center;
        margin: 10px 0;
    }
</style>
</head>
<body>
<div id="loadingContainer">
    <span>Loading annotations:</span>
    <span id="loadingProgress">Getting list of files...</span>
</div>
<h2>Handmade Hero Annotations Search</h2>
<div class="queryContainer">
    <label>Query:</label> <input type="text" id="query" autofocus></input>
</div>
<div id="resultsSummary"></div>
<div id="results">
</div>

<script>
var fileListsToLoad = 0;
var fileListsLoaded = 0;

var itemsToLoad = 0;
var itemsLoaded = 0;
var ready = false;

var resultsToRender = [];
var resultsIndex = 0;
var benchData = 0;
var resultsContainer = document.getElementById("results");
var rendering = false;

var dayContainerPrototype = document.createElement("DIV");
dayContainerPrototype.classList.add("dayContainer");

var dayNamePrototype = document.createElement("SPAN");
dayNamePrototype.classList.add("dayName");
dayContainerPrototype.appendChild(dayNamePrototype);

var markerListPrototype = document.createElement("DIV");
markerListPrototype.classList.add("markerList");
dayContainerPrototype.appendChild(markerListPrototype);

var markerPrototype = document.createElement("A");
markerPrototype.classList.add("marker");
markerPrototype.setAttribute("target", "_blank");

var highlightPrototype = document.createElement("B");

var fileList = [];

var episodes = [];

function fileListLoaded(data) {
    fileListsLoaded++;
    var files = [];
    for (var i = data.data.length-1; i >= 0; --i) {
        var file = data.data[i];
        files.push({
            name: file.name,
            path: "https://raw.githubusercontent.com/HandmadeCompanion/HandmadeCompanion/master/" + file.path
        });
    }
    addFilesToList(files);
}

function addFilesToList(files) {
    fileList = fileList.concat(files);
    if (fileListsLoaded == fileListsToLoad) {
        itemsToLoad = fileList.length;
        for (var i = 0; i < fileList.length; ++i) {
            addFile(fileList[i].name, fileList[i].path, i);
        }
    }
}

function addFile(name, filepath, idx) {
    var xhr = new XMLHttpRequest();
    xhr.addEventListener("load", function() {
        itemsLoaded++;
        if (itemsLoaded == itemsToLoad) {
            document.getElementById("loadingContainer").style.display = "none";
        } else {
            document.getElementById("loadingProgress").textContent = itemsLoaded + "/" + itemsToLoad;
        }
        var contents = xhr.response;

        var lines = contents.split("\n");
        var title = null;
        var videoId = null;
        var markers = [];
        var day = name.slice(0, name.indexOf("."));
        var dayParts = day.match(/([a-zA-Z_-]+)([0-9]+)?([a-zA-Z]+)?/);
        day = dayParts[1].slice(0, 1).toUpperCase() + dayParts[1].slice(1) + (dayParts[2] ? " " + dayParts[2] : "") + (dayParts[3] ? " " + dayParts[3].toUpperCase() : "");
        var mode = "none";
        for (var i = 0; i < lines.length; ++i) {
            var line = lines[i];
            if (line == "---") {
                mode = "none";
            } else if (line.startsWith("title:")) {
                title = line.slice(7).replace(/"/g, "");
            } else if (line.startsWith("videoId:")) {
                videoId = line.slice(9).replace(/"/g, "");
            } else if (line.startsWith("markers")) {
                mode = "markers";
            } else if (mode == "markers") {
                var match = line.match(/"((\d+):)?(\d+):(\d+)": "(.+)"/);
                if (match == null) {
                    console.log(name, line);
                } else {
                    var totalTime = (match[2] ? parseInt(match[2], 10) : 0) * 60 * 60 + parseInt(match[3], 10) * 60 + parseInt(match[4], 10);
                    var marker = {
                        totalTime: totalTime,
                        prettyTime: markerTime(totalTime),
                        text: match[5].replace(/\\"/g, "\"")
                    }
                    markers.push(marker);
                }
            }
        }
        episodes.push({
            day: day,
            title: title,
            videoId: videoId,
            markers: markers,
            filename: name.slice(0, name.indexOf(".")),
            filepath: filepath
        });

        if (itemsLoaded == itemsToLoad) {
            episodes = episodes.sort(function(a, b) {
                return a.day.localeCompare(b.day);
            });
            episodes.reverse();
            ready = true;
            runSearch();
        }
    });
    xhr.open("GET", filepath);
    xhr.setRequestHeader("Content-Type", "text/plain");
    xhr.send();
}

function markerTime(totalTime) {
    var markTime = "(";
    var hours = Math.floor(totalTime / 60 / 60);
    var minutes = Math.floor(totalTime / 60) % 60;
    var seconds = totalTime % 60;
    if (hours > 0) {
        markTime += padTimeComponent(hours) + ":";
    }

    markTime += padTimeComponent(minutes) + ":" + padTimeComponent(seconds) + ")";

    return markTime;
}

function padTimeComponent(component) {
    return (component < 10 ? "0" + component : component);
}

function runSearch() {
    var queryStr = document.getElementById("query").value;
    while (resultsContainer.firstChild) {
        resultsContainer.removeChild(resultsContainer.firstChild);
    }
    resultsToRender = [];
    resultsIndex = 0;
    benchData = 0;
    var numEpisodes = 0;
    var numMarkers = 0;
    var totalSeconds = 0;
    if (ready) {
        if (queryStr && queryStr.length > 0) {
            var query = new RegExp(queryStr.replace("(", "\\(").replace(")", "\\)").replace(/(^|[^\\])\\$/, "$1"), "gi");
            for (var i = 0; i < episodes.length; ++i) {
                var episode = episodes[i];
                var matches = [];
                for (var j = 0; j < episode.markers.length; ++j) {
                    query.lastIndex = 0;
                    var result = query.exec(episode.markers[j].text);
                    if (result && result[0].length > 0) {
                        numMarkers++;
                        matches.push(episode.markers[j]);
                        if (j < episode.markers.length-1) {
                            totalSeconds += episode.markers[j+1].totalTime - episode.markers[j].totalTime;
                        }
                    }
                }
                if (matches.length > 0) {
                    numEpisodes++;
                    resultsToRender.push({
                        query: query,
                        episode: episode,
                        matches: matches
                    });
                }
            }

            if (!rendering) {
                renderResults();
            }
        }

        var totalTime = Math.floor(totalSeconds/60/60) + "h " + Math.floor(totalSeconds/60)%60 + "m " + totalSeconds%60 + "s ";

        document.getElementById("resultsSummary").textContent = "Found: " + numEpisodes + " episodes, " + numMarkers + " markers, " + totalTime + "total.";
    }
}

function renderMatches(query, episode, matches) {
    var dayContainer = dayContainerPrototype.cloneNode(true);
    var dayName = dayContainer.children[0];
    var markerList = dayContainer.children[1];
    dayName.textContent = episode.day + ": " + episode.title;

    for (var k = 0; k < matches.length; ++k) {
        var marker = markerPrototype.cloneNode();
        marker.setAttribute("href", "http://asafgartner.github.io/annotations_player/hmh.html#" + episode.filename + "#" + matches[k].totalTime);
        query.lastIndex = 0;
        var cursor = 0;
        var text = matches[k].text;
        var result = null;
        marker.appendChild(document.createTextNode(matches[k].prettyTime + " "));
        while (result = query.exec(text)) {
            if (result.index > cursor) {
                marker.appendChild(document.createTextNode(text.slice(cursor, result.index)));
            }
            var highlightEl = highlightPrototype.cloneNode();
            highlightEl.textContent = result[0];
            marker.appendChild(highlightEl);
            cursor = result.index + result[0].length;
        }

        if (cursor < text.length) {
            marker.appendChild(document.createTextNode(text.slice(cursor, text.length)));
        }
        markerList.appendChild(marker);
    }
    resultsContainer.appendChild(dayContainer);
}

function renderResults() {
    if (resultsIndex < resultsToRender.length) {
        rendering = true;
        var renderStart = performance.now();
        while (resultsIndex < resultsToRender.length && performance.now() - renderStart < 1) {
            renderMatches(resultsToRender[resultsIndex].query, resultsToRender[resultsIndex].episode, resultsToRender[resultsIndex].matches);
            resultsIndex++;
        }
        benchData++;
        requestAnimationFrame(renderResults);
    } else {
        rendering = false;
        console.log("Num frames:", benchData, "Average items:", resultsToRender.length / benchData);
    }
}

fileListsToLoad = 3;
var script = document.createElement("SCRIPT");
script.setAttribute("src", "https://api.github.com/repos/HandmadeCompanion/HandmadeCompanion/contents/src/documents/videos/code?callback=fileListLoaded");
document.body.appendChild(script);

var script = document.createElement("SCRIPT");
script.setAttribute("src", "https://api.github.com/repos/HandmadeCompanion/HandmadeCompanion/contents/src/documents/videos/chat?callback=fileListLoaded");
document.body.appendChild(script);

var script = document.createElement("SCRIPT");
script.setAttribute("src", "https://api.github.com/repos/HandmadeCompanion/HandmadeCompanion/contents/src/documents/videos/misc?callback=fileListLoaded");
document.body.appendChild(script);

var queryEl = document.getElementById("query")
queryEl.addEventListener("input", function(ev) {
    runSearch();
});
</script>
</body>
</html>
